# LKI - Analyse Immobili√®re & Business Plan

Application web pour l'analyse des transactions immobili√®res (DVF), la g√©n√©ration de business plan et la cr√©ation de rapports PDF.

## üìã Table des mati√®res
- [Description](#-description)
- [Fonctionnalit√©s principales](#-fonctionnalit√©s-principales)
- [Pr√©requis](#-pr√©requis)
- [Installation & Configuration](#-installation--configuration)
- [Structure du projet](#-structure-du-projet)
- [Fonctionnalit√©s d√©taill√©es](#-fonctionnalit√©s-d√©taill√©es)
- [API & Endpoints](#-api--endpoints)
- [D√©ploiement & Production](#-d√©ploiement--production)
- [Maintenance & Sauvegarde](#-maintenance--sauvegarde)
- [S√©curit√©](#-s√©curit√©)
- [Tests & Qualit√©](#-tests--qualit√©)
- [Contribution](#-contribution)
- [FAQ & D√©pannage](#-faq--d√©pannage)
- [Glossaire](#-glossaire)
- [Changelog](#-changelog)
- [üîÑ Migration & Refactoring (2024)](#-migration--refactoring-2024)
- [Architecture des Types et Flux de Donn√©es](#-architecture-des-types-et-flux-de-donn√©es)

## üöÄ Description

LKI est une application compl√®te pour l'analyse et la gestion de projets immobiliers. Elle permet de :
- Analyser les transactions immobili√®res (DVF) autour d'un bien
- G√©n√©rer des business plans d√©taill√©s
- Cr√©er des rapports PDF professionnels
- G√©rer une base de projets immobiliers

## üõ†Ô∏è Pr√©requis
- Node.js >= 18
- npm >= 8
- PostgreSQL >= 13
- Google Maps API Key

## ‚öôÔ∏è Installation & Configuration

1. **Cloner le d√©p√¥t**
   ```bash
   git clone <url-du-repo>
   cd <nom-du-repo>
   ```

2. **Installer les d√©pendances**
   ```bash
   cd backend && npm install
   cd ../frontend && npm install
   ```

3. **Configurer les variables d'environnement**
   - Copier `.env.example` en `.env` dans `backend/` et `frontend/`
   - Renseigner les variables (DB, API keys, etc.)

**Backend** (`backend/.env`) :
```env
DATABASE_URL="postgresql://postgres:new_secure_password_2025@163.172.32.45:5432/lki_db"
JWT_SECRET="your-secret-key"
PORT=3001
NODE_ENV=development
BASE_PDF_IMAGE_URL=http://localhost:3001
```

**Frontend** (`frontend/.env.local`) :
```env
NEXT_PUBLIC_GOOGLE_MAPS_API_KEY='AIzaSyDrxyRde3ZTmrpmid5De5Wo33YjAx2MvT0'
NEXT_PUBLIC_API_URL=http://163.172.32.45:3001
```

> ‚ö†Ô∏è **Ne jamais committer ces fichiers dans le d√©p√¥t !**

4. **Base de donn√©es**
   ```bash
   createdb lki_db
   psql -d lki_db -f backend/scripts/dvf_functions.sql
   ```

5. **Lancer Prisma Studio**
   ```bash
   cd backend
   npx prisma studio
   ```
   Acc√®s : [http://localhost:5555](http://localhost:5555)

## üèÅ Lancement

1. **D√©marrer PostgreSQL**
   ```bash
   sudo systemctl start postgresql
   ```

2. **Backend**
   ```bash
   cd backend
   npm run dev
   # ou en production : npm run build && npm start
   ```

3. **Frontend**
   ```bash
   cd frontend
   npm run dev
   # ou en production : npm run build && npm start
   ```

4. **Acc√©der √† l'application**
   - [http://localhost:3000](http://localhost:3000)

## üñ•Ô∏è Fonctionnalit√©s principales

### Description du bien
- Saisie des caract√©ristiques g√©n√©rales (surface, terrasse, etc.)
- Param√®tres qualitatifs (vue, √©tage, ascenseur, etc.)
- Calcul automatique du coefficient de pond√©ration
- Visualisation des impacts sur la valeur
- Persistance des donn√©es entre les onglets

### Analyse DVF
- Recherche de transactions immobili√®res dans un rayon
- Visualisation sur carte Google Maps interactive
- Statistiques d√©taill√©es (prix/m¬≤, m√©dianes, etc.)
- Gestion des outliers
- Persistance des donn√©es DVF (transactions, s√©ries, distributions)
- Filtrage des transactions par rayon
- Affichage du cercle de recherche sur la carte

### Business Plan
- Saisie et √©dition des donn√©es financi√®res
- Calcul automatique (prix de revient, marge, TRI, cash-flow)
- Visualisation des r√©sultats et tableaux de synth√®se
- Enregistrement des inputs et r√©sultats

### Rapports PDF
- G√©n√©ration de rapports personnalis√©s
- S√©lection des sections √† inclure
- Int√©gration des photos
- Personnalisation du style

### Gestion des photos
- Upload par cat√©gorie (before, 3d, during, after)
- S√©lection pour le PDF
- Organisation et visualisation
- Gestion des fichiers

## üîÑ Derni√®res am√©liorations (2024)

### Persistance des donn√©es
- Sauvegarde automatique des donn√©es DVF en base
- Tables d√©di√©es pour les transactions, s√©ries et distributions
- Chargement initial des donn√©es depuis la base
- √âvite les re-fetch inutiles lors des changements d'onglet

### Interface utilisateur
- Nouvelle interface pour la description du bien
- Visualisation des impacts sur la valeur
- Carte Google Maps interactive
- Affichage du rayon de recherche DVF
- Navigation fluide entre les onglets

### Validation et robustesse
- Validation Zod c√¥t√© frontend et backend
- Gestion des erreurs am√©lior√©e
- Types TypeScript stricts
- Protection contre les donn√©es manquantes

### Performance
- Optimisation des requ√™tes DVF
- Mise en cache des donn√©es
- Chargement progressif des composants
- R√©duction des appels API

## üóÇÔ∏è Structure du projet

```
<repo-root>/
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ controllers/    # Logique m√©tier
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes/        # Endpoints API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/      # Services m√©tiers
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types/         # Types TypeScript
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ utils/         # Utilitaires
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templates/     # Templates PDF
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config/        # Configuration
‚îÇ   ‚îú‚îÄ‚îÄ prisma/            # Sch√©ma DB
‚îÇ   ‚îú‚îÄ‚îÄ scripts/           # Scripts SQL
‚îÇ   ‚îî‚îÄ‚îÄ dist/              # Code compil√©
‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/    # Composants React
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pages/        # Pages Next.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/     # Services front
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hooks/        # Hooks React
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ context/      # Context React
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ store/        # √âtat global
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ styles/       # Styles CSS
‚îÇ   ‚îú‚îÄ‚îÄ public/           # Assets statiques
‚îÇ   ‚îî‚îÄ‚îÄ .next/            # Build Next.js
‚îî‚îÄ‚îÄ uploads/              # Photos et fichiers
```

## üîó API & Endpoints

### Projets
- `GET /api/projects` : Liste tous les projets
- `GET /api/project/:id` : D√©tails d'un projet
- `POST /api/project` : Cr√©er un projet
- `PUT /api/project/:id` : Mettre √† jour un projet
- `DELETE /api/project/:id` : Supprimer un projet

### Business Plan
- `PUT /api/business-plan/:projectId` : Mise √† jour des inputs
- `POST /api/business-plan/:projectId/calculate` : Calcul
- `GET /api/business-plan/:projectId` : R√©cup√©ration

### DVF (Analyse des transactions immobili√®res)
- `POST /api/dvf/analyse` : **Route unifi√©e** pour toutes les analyses DVF (statistiques, propri√©t√©s, s√©ries temporelles, distribution, scatter plot)
  - Cette route retourne en une seule requ√™te :
    - Les statistiques globales (moyennes, bornes, premium, outliers, etc.)
    - La liste des transactions filtr√©es
    - Les s√©ries temporelles (√©volution annuelle)
    - La distribution des prix (histogramme)
    - Le scatter plot (dispersion prix/surface)
- Les anciennes routes (`/base-stats`, `/properties`, `/trend-series`, `/distribution-series`, `/scatter-series`, etc.) sont conserv√©es pour compatibilit√© mais **ne sont plus n√©cessaires** pour un usage standard.

### PDF
- `GET /api/pdf/:projectId` : G√©n√©ration
- `GET /api/pdf/:projectId/config` : Configuration
- `PUT /api/pdf/:projectId/config` : Mise √† jour config

### Photos
- `POST /api/photos/:projectId/:category` : Upload
- `POST /api/photos/:projectId/toggle-pdf` : S√©lection PDF
- `DELETE /api/photos/:projectId/:category/:index` : Suppression

## üè≠ D√©ploiement & Production

### Recommandations
- Reverse proxy (Nginx/Caddy)
- SSL obligatoire (Let's Encrypt)
- Monitoring (UptimeRobot, Grafana)
- Logs (pm2, journalctl)

### Configuration du serveur
  ```bash
sudo apt update
sudo apt install nginx postgresql nodejs npm
# Configurer Nginx pour proxy_pass sur le frontend et backend
```

### D√©ploiement
```bash
# Backend
cd backend
npm install --production
npm run build
pm2 start dist/app.js --name "lki-backend"

# Frontend
cd frontend
npm install --production
npm run build
pm2 start npm --name "lki-frontend" -- start
```

### Scripts utiles
```bash
# Migration Prisma
npx prisma migrate dev

# G√©n√©rer client Prisma
npx prisma generate

# Backup DB
pg_dump lki_db > backup/lki_db_$(date +%Y%m%d).sql

# Restaurer DB
psql lki_db < backup/lki_db_YYYYMMDD.sql
```

## üíæ Maintenance & Sauvegarde

### Sauvegarde du projet
```bash
# Dossier de travail
tar czvf /home/jeanphaie/backup/backup_lki_$(date +%Y%m%d_%H%M%S).tar.gz /data/lki

# Base de donn√©es
pg_dump lki_db > backup/lki_db_$(date +%Y%m%d).sql
```

### Restauration
```bash
# Dossier de travail
tar xzvf backup/backup_lki_YYYYMMDD_HHMMSS.tar.gz -C /

# Base de donn√©es
psql lki_db < backup/lki_db_YYYYMMDD.sql
```

### Automatisation des sauvegardes
```bash
crontab -e
# Ajouter la ligne suivante pour une sauvegarde quotidienne √† 2h du matin
0 2 * * * /chemin/vers/backup_script.sh
```

## üõ°Ô∏è S√©curit√©

### Bonnes pratiques
- Variables d'environnement pour les secrets
- Pas de commit de donn√©es sensibles
- Acc√®s SSH s√©curis√© (firewall, fail2ban)
- Mises √† jour r√©guli√®res des d√©pendances
- Limiter les droits d'acc√®s aux dossiers sensibles (`uploads/`, `backups/`, etc.)

### Monitoring
- Surveillance des logs
- Alertes de s√©curit√©
- Backups automatiques
- Tests de restauration

## üß™ Tests & Qualit√©

### Tests
- **Backend** : tests unitaires avec Jest/Mocha
- **Frontend** : tests unitaires avec React Testing Library/Jest
- **Linting** : ESLint + Prettier
- **CI/CD** : GitHub Actions (workflow √† configurer)

## üßë‚Äçüíª Contribution

### Processus
1. Fork du projet
2. Branche d√©di√©e
3. Tests et documentation
4. Pull Request

### Conventions
- Snake_case pour les champs
- Tests pour les nouvelles fonctionnalit√©s
- Documentation √† jour
- Code review obligatoire

### Standards de code
- Utiliser TypeScript strict
- Suivre les conventions de nommage (camelCase pour JS/TS, snake_case pour SQL)
- Documenter les nouvelles fonctionnalit√©s
- Ajouter des tests unitaires

## ‚ùì FAQ & D√©pannage

### Probl√®mes courants
- **Coh√©rence co√ªt/financement** : V√©rifier `businessPlanController.ts`
- **Erreur de build** : Relancer `npm install`
- **API Google Maps** : V√©rifier cl√© et quotas
- **Erreur de connexion √† la base de donn√©es**
  ```bash
  sudo systemctl status postgresql
  sudo journalctl -u postgresql
  ```
- **Probl√®mes de PDF**
  ```bash
  chmod -R 755 /data/lki/uploads
  df -h
  ```

### Support
- Issues GitHub
- Documentation technique
- Tests de non-r√©gression

## üìö Pour aller plus loin

### Am√©liorations futures
- Tests end-to-end (Cypress/Playwright)
- Script de seed pour tests/d√©mo
- Script de purge/clean
- Monitoring avanc√©
- CI/CD automatis√©

### Roadmap
1. **Court terme**
   - Am√©lioration des performances DVF
   - Optimisation de la g√©n√©ration PDF
   - Ajout de graphiques interactifs
   - Export des donn√©es en Excel

2. **Moyen terme**
   - Application mobile
   - API publique
   - Int√©gration de nouvelles sources de donn√©es
   - Syst√®me de notifications

3. **Long terme**
   - IA pour l'analyse de march√©
   - Marketplace de projets
   - Collaboration en temps r√©el
   - Int√©gration blockchain

## üìñ Glossaire

### Termes techniques
- **DVF** : Demande de Valeur Fonci√®re, base de donn√©es des transactions immobili√®res
- **TRI** : Taux de Rentabilit√© Interne
- **FAI** : Frais d'Agence Inclus
- **HFA** : Hors Frais d'Agence
- **Prisma** : ORM pour la base de donn√©es
- **PM2** : Process Manager pour Node.js

### Termes m√©tier
- **Prix de revient** : Co√ªt total du projet (acquisition + travaux + frais)
- **Marge brute** : Diff√©rence entre prix de vente et prix de revient
- **Cash-flow** : Flux de tr√©sorerie mensuel
- **Outliers** : Valeurs aberrantes dans les statistiques DVF

## üìù Changelog

### v1.0.0 (2024-03-20)
- üéâ Version initiale
- ‚ú® Business Plan complet
- üó∫Ô∏è Int√©gration DVF
- üìÑ G√©n√©ration PDF
- üì∏ Gestion des photos

### v0.9.0 (2024-02-15)
- üöß Version beta
- üìä Calculs financiers
- üèóÔ∏è Structure de base
- üîç Recherche DVF

## üîß D√©veloppement

### Commandes utiles
```bash
# Lancer les tests
npm run test

# Lancer le linter
npm run lint

# V√©rifier les types
npm run type-check

# Build en production
npm run build

# D√©veloppement
npm run dev
```

### Workflow Git
1. Cr√©er une branche depuis `main`
   ```bash
   git checkout -b feature/nouvelle-fonctionnalite
   ```
2. D√©velopper et commiter
   ```bash
   git add .
   git commit -m "feat: ajout nouvelle fonctionnalit√©"
   ```
3. Pousser et cr√©er une PR
   ```bash
   git push origin feature/nouvelle-fonctionnalite
   ```

### Conventions de commit
- `feat:` Nouvelle fonctionnalit√©
- `fix:` Correction de bug
- `docs:` Documentation
- `style:` Formatage
- `refactor:` Refactoring
- `test:` Tests
- `chore:` Maintenance

## ü§ù Support & Communaut√©

### Ressources
- [Documentation API](https://api.lki.fr/docs)
- [Guide d'utilisation](https://docs.lki.fr)
- [Forum communautaire](https://community.lki.fr)
- [Blog technique](https://blog.lki.fr)

### Contribuer
- [Guide de contribution](CONTRIBUTING.md)
- [Code de conduite](CODE_OF_CONDUCT.md)
- [Template de PR](.github/PULL_REQUEST_TEMPLATE.md)
- [Template d'issue](.github/ISSUE_TEMPLATE.md)

## üë§ Contact
- [Ton Nom] ‚Äî [ton.email@exemple.com]
- [Site web](https://lki.fr)
- [Twitter](https://twitter.com/lki)
- [LinkedIn](https://linkedin.com/company/lki)

## üìÑ Licence
MIT (ou √† pr√©ciser)

---

<div align="center">
  <sub>Built with ‚ù§Ô∏è by the LKI team</sub>
</div>

## üîÑ Migration & Refactoring (2024)

### Type System Migration

#### Overview
- Centralized all TypeScript + Zod types in `shared/types/`
- Removed duplicate type definitions from frontend and backend
- Enforced strict type safety across the entire application
- Aligned database schema with shared types

#### Key Changes

1. **Shared Types Structure**
   ```
   shared/types/
   ‚îú‚îÄ‚îÄ project.ts         # Main Project type and subtypes
   ‚îú‚îÄ‚îÄ business-plan.ts   # Business plan inputs and results
   ‚îú‚îÄ‚îÄ descriptionBien.ts # Property description
   ‚îú‚îÄ‚îÄ dvf.ts            # DVF analysis types
   ‚îú‚îÄ‚îÄ photo.ts          # Photo management
   ‚îî‚îÄ‚îÄ pdf.ts            # PDF generation
   ```

2. **Database Schema Updates**
   - Moved general info into `inputsGeneral` (JSON)
   - Kept `resultsDvfMetadata` in Project table
   - Moved large DVF data to dedicated tables
   - Made `projectTitle` standalone column
   - Using auto-incremented integer as primary key

3. **Service Layer Refactoring**
   - Centralized all project data access in `ProjectService`
   - Removed direct Prisma access from routes
   - Added strict validation using shared Zod schemas
   - Normalized data structure (null ‚Üí undefined)
   - Added default values for all fields

4. **Route Updates**
   - Removed obsolete fields (photosBefore, coverPhoto, etc.)
   - Replaced `z.any()` with proper Zod schemas
   - Centralized data normalization
   - Added proper error handling
   - Enforced type safety in all endpoints

5. **Frontend Integration**
   - Removed local type definitions
   - Updated all components to use shared types
   - Added proper type checking for API responses
   - Improved error handling and validation

### Migration Process

1. **Type Definition**
   ```typescript
   // Example of shared type definition
   export const ProjectSchema = z.object({
     id: z.number(),
     projectTitle: z.string(),
     inputsGeneral: InputsGeneralSchema,
     // ... other fields
   });
   ```

2. **Service Implementation**
   ```typescript
   // Example of service method
   async getProjectById(id: number): Promise<Project> {
     const project = await prisma.project.findUnique({...});
     return this.validateAndMapProject(project);
   }
   ```

3. **Route Handler**
   ```typescript
   // Example of route handler
   router.put('/:id', async (req, res) => {
     const updates = ProjectUpdateSchema.parse(req.body);
     const project = await projectService.updateProject(id, updates);
     res.json(project);
   });
   ```

### Testing & Validation

1. **Integration Tests**
   ```typescript
   describe('Project Service', () => {
     it('should validate project data', async () => {
       const project = await projectService.getProjectById(1);
       expect(ProjectSchema.safeParse(project).success).toBe(true);
     });
   });
   ```

2. **Type Checking**
   - Added `tsc --noEmit` to CI pipeline
   - Enforced strict mode in TypeScript config
   - Added runtime validation with Zod

### Best Practices

1. **Type Safety**
   - Always use shared types for API requests/responses
   - Validate all data at boundaries
   - Use Zod for runtime validation
   - Avoid type assertions

2. **Data Access**
   - Use ProjectService for all data operations
   - Validate data before saving
   - Normalize data structure
   - Handle errors properly

3. **Code Organization**
   - Keep types in shared folder
   - Use proper imports
   - Document complex types
   - Follow naming conventions

### Future Improvements

1. **Planned Updates**
   - Add more comprehensive tests
   - Improve error messages
   - Add data migration tools
   - Enhance type documentation

2. **Monitoring**
   - Add type coverage metrics
   - Track validation errors
   - Monitor performance impact
   - Log type-related issues

### Migration Checklist

- [x] Centralize all types
- [x] Update database schema
- [x] Refactor services
- [x] Update routes
- [x] Update frontend
- [x] Add validation
- [x] Add tests
- [x] Update documentation

### Related Documentation

- See `TABS.md` for detailed documentation of each tab
- See `MIGRATION_PLAN.md` for the complete migration plan
- See `API.md` for updated API documentation

## üìö Architecture des Types et Flux de Donn√©es

### üìö Structure des Types

#### 1. Base de Donn√©es (Prisma)
```typescript
// schema.prisma
model Project {
  id                    Int      @id @default(autoincrement())
  projectTitle         String
  inputsGeneral        Json?    // Stock√© en JSON dans la BDD
  inputsDescriptionBien Json?
  resultsDescriptionBien Json?
  inputsBusinessPlan   Json?
  resultsBusinessPlan  Json?
  inputsDvf           Json?
  resultsDvfMetadata  Json?
  photos              Json?
  pdfConfig           Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}
```

#### 2. Types Partag√©s (`shared/types/`)
Les types partag√©s d√©finissent la structure des objets JSON stock√©s en base de donn√©es.

```typescript
// shared/types/dvf.ts
export const DvfPropertySchema = z.object({
    id: z.number(),
    latitude: z.number(),
    longitude: z.number(),
    // ...
});

export type DvfProperty = z.infer<typeof DvfPropertySchema>;
```

### üîÑ Flux de Donn√©es

#### 1. Frontend ‚Üí Backend
```typescript
// frontend/src/components/project-sections/DvfAnalysis.tsx
const fetchDvfData = async () => {
    // 1. Envoi des donn√©es au backend
    const response = await fetch(`/api/dvf/${project.id}/analyse`, {
        method: 'POST',
        body: JSON.stringify(requestData)
    });
    
    // 2. Validation des donn√©es re√ßues
    const validatedData = DvfAnalyseResponseSchema.parse(rawData);
}
```

#### 2. Backend ‚Üí Base de Donn√©es
```typescript
// backend/src/services/project.service.ts
async getProjectById(id: number): Promise<Project | null> {
    // 1. R√©cup√©ration des donn√©es brutes
    const project = await prisma.project.findUnique({
        where: { id },
        select: {
            id: true,
            inputsGeneral: true,
            // ...
        }
    });

    // 2. Validation et transformation
    return {
        id: project.id,
        inputsGeneral: this.validateJson<InputsGeneral>(project.inputsGeneral),
        // ...
    };
}
```

### üìù Guide d'Utilisation

#### 1. Ajouter un Nouveau Champ
1. V√©rifier dans `shared/types/` si le type existe
2. Si non, cr√©er le type avec sa documentation :
```typescript
// shared/types/nouveau-type.ts
export const NouveauTypeSchema = z.object({
    champ1: z.number(),
    champ2: z.string(),
    // ...
});

export type NouveauType = z.infer<typeof NouveauTypeSchema>;

/**
 * Documentation du type
 * @param champ1 - Description du champ1
 * @param champ2 - Description du champ2
 */
```

#### 2. Modifier un Champ Existant
1. Localiser le type dans `shared/types/`
2. Modifier le sch√©ma Zod et le type TypeScript
3. Mettre √† jour la documentation
4. V√©rifier les impacts sur le frontend et le backend

#### 3. Validation des Donn√©es
```typescript
// Validation avec Zod
const result = MonSchema.safeParse(data);
if (!result.success) {
    console.error('Erreurs de validation:', result.error.errors);
    return;
}
const validatedData = result.data;
```

### üèóÔ∏è Structure des Dossiers

```
project/
‚îú‚îÄ‚îÄ shared/
‚îÇ   ‚îî‚îÄ‚îÄ types/           # Types partag√©s
‚îÇ       ‚îú‚îÄ‚îÄ project.ts   # Types du projet
‚îÇ       ‚îú‚îÄ‚îÄ dvf.ts       # Types DVF
‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ       ‚îî‚îÄ‚îÄ components/  # Composants React
‚îî‚îÄ‚îÄ backend/
    ‚îî‚îÄ‚îÄ src/
        ‚îî‚îÄ‚îÄ services/    # Services backend
```

### üîç Bonnes Pratiques

1. **Centralisation des Types**
   - Tous les types partag√©s doivent √™tre dans `shared/types/`
   - √âviter la duplication des types
   - Utiliser des types d√©riv√©s quand possible

2. **Validation**
   - Valider les donn√©es √† chaque √©tape (frontend ‚Üí backend ‚Üí BDD)
   - Utiliser Zod pour la validation
   - G√©rer proprement les erreurs de validation

3. **Documentation**
   - Documenter chaque type avec des commentaires JSDoc
   - Expliquer les contraintes m√©tier
   - Donner des exemples d'utilisation

4. **Typage Strict**
   - √âviter `any` et `unknown`
   - Utiliser des types pr√©cis
   - Lever des erreurs de compilation plut√¥t que des erreurs runtime

### üöÄ Exemple Complet

#### 1. D√©finition du Type
```typescript
// shared/types/dvf.ts
export const DvfPropertySchema = z.object({
    id: z.number(),
    latitude: z.number(),
    longitude: z.number(),
    prix: z.number(),
    surface: z.number(),
    prix_m2: z.number(),
    date_mutation: z.string(),
    adresse: z.string(),
    code_postal: z.string(),
    ville: z.string(),
    type: z.string(),
    is_outlier: z.boolean(),
});

export type DvfProperty = z.infer<typeof DvfPropertySchema>;
```

#### 2. Utilisation dans le Frontend
```typescript
// frontend/src/components/DvfTab.tsx
import { DvfProperty } from '../../../../shared/types/dvf';

interface Props {
    properties: DvfProperty[];
}

const DvfTab: React.FC<Props> = ({ properties }) => {
    // TypeScript conna√Æt la structure de properties
    return (
        <div>
            {properties.map(prop => (
                <div key={prop.id}>
                    {prop.adresse} - {prop.prix_m2}‚Ç¨/m¬≤
                </div>
            ))}
        </div>
    );
};
```

#### 3. Utilisation dans le Backend
```typescript
// backend/src/services/dvf.service.ts
import { DvfPropertySchema } from '../../../../shared/types/dvf';

async function validateAndSaveProperty(data: unknown): Promise<DvfProperty> {
    const result = DvfPropertySchema.safeParse(data);
    if (!result.success) {
        throw new Error('Donn√©es invalides');
    }
    return result.data;
}
```

### ‚ö†Ô∏è Points d'Attention

1. **Coh√©rence des Types**
   - Maintenir la coh√©rence entre frontend et backend
   - √âviter les divergences de structure
   - Documenter les changements

2. **Performance**
   - √âviter les validations inutiles
   - Optimiser les sch√©mas Zod
   - Mettre en cache les validations fr√©quentes

3. **S√©curit√©**
   - Valider toutes les entr√©es utilisateur
   - Sanitizer les donn√©es sensibles
   - G√©rer les erreurs proprement

### üîß Outils Recommand√©s

1. **VS Code Extensions**
   - TypeScript
   - Zod
   - Prisma

2. **Linting**
   - ESLint
   - TypeScript ESLint
   - Prettier

3. **Documentation**
   - JSDoc
   - TypeDoc
   - Markdown

### üìö Ressources

- [Documentation Zod](https://zod.dev/)
- [Documentation Prisma](https://www.prisma.io/docs)
- [Documentation TypeScript](https://www.typescriptlang.org/docs/)

# Structure des Types Partag√©s (LKI)

## üì¶ Principe

- **1 fichier = 1 champ JSON** (ou 1 bloc m√©tier de la BDD)
- **Pas de factorisation ni d'abstraction inutile**
- **Chaque fichier contient un sch√©ma Zod et un type TypeScript strictement align√© sur la structure valid√©e**
- **Le type `Project` centralise tous les imports et sous-champs**

## üìÅ Arborescence

```
shared/types/
‚îú‚îÄ‚îÄ businessPlanInputs.ts
‚îú‚îÄ‚îÄ businessPlanResults.ts
‚îú‚îÄ‚îÄ descriptionBienInputs.ts
‚îú‚îÄ‚îÄ descriptionBienResults.ts
‚îú‚îÄ‚îÄ dvfDistribution.ts
‚îú‚îÄ‚îÄ dvfScatter.ts
‚îú‚îÄ‚îÄ dvfSeries.ts
‚îú‚îÄ‚îÄ dvfTransaction.ts
‚îú‚îÄ‚îÄ inputsDvf.ts
‚îú‚îÄ‚îÄ inputsGeneral.ts
‚îú‚îÄ‚îÄ inputsRenovationBien.ts
‚îú‚îÄ‚îÄ pdf.ts
‚îú‚îÄ‚îÄ photos.ts
‚îú‚îÄ‚îÄ project.ts
‚îú‚îÄ‚îÄ resultsDvfMetadata.ts
‚îú‚îÄ‚îÄ resultsRenovationBien.ts
```

## üß© Exemple de fichier (inputsGeneral)
```ts
import { z } from 'zod';

export const InputsGeneralSchema = z.object({
  projectTitle: z.string(),
  superficie: z.number(),
  superficie_terrasse: z.number(),
  ponderation_terrasse: z.number(),
  description_quartier: z.string().optional(),
  latitude: z.number().optional(),
  longitude: z.number().optional(),
});

export type InputsGeneral = z.infer<typeof InputsGeneralSchema>;
```

## üèóÔ∏è Type Project central
```ts
import { z } from 'zod';
import { InputsGeneralSchema } from './inputsGeneral';
import { InputsDvfSchema } from './inputsDvf';
import { ResultsDvfMetadataSchema } from './resultsDvfMetadata';
import { BusinessPlanInputsSchema } from './businessPlanInputs';
import { BusinessPlanResultsSchema } from './businessPlanResults';
import { PdfConfigSchema } from './pdf';
import { PhotosSchema } from './photos';
import { InputsRenovationBienSchema } from './inputsRenovationBien';
import { ResultsRenovationBienSchema } from './resultsRenovationBien';
import { DescriptionBienInputsSchema } from './descriptionBienInputs';
import { DescriptionBienResultsSchema } from './descriptionBienResults';
import { DvfTransactionSchema } from './dvfTransaction';
import { DvfSeriesSchema } from './dvfSeries';
import { DvfDistributionSchema } from './dvfDistribution';
import { DvfScatterSchema } from './dvfScatter';

export const ProjectSchema = z.object({
  id: z.number(),
  projectTitle: z.string(),
  createdAt: z.string(),
  updatedAt: z.string(),
  inputsGeneral: InputsGeneralSchema,
  inputsDvf: InputsDvfSchema.optional(),
  resultsDvfMetadata: ResultsDvfMetadataSchema.optional(),
  inputsBusinessPlan: BusinessPlanInputsSchema.optional(),
  resultsBusinessPlan: BusinessPlanResultsSchema.optional(),
  pdfConfig: PdfConfigSchema.optional(),
  photos: PhotosSchema.optional(),
  inputsRenovationBien: InputsRenovationBienSchema.optional(),
  resultsRenovationBien: ResultsRenovationBienSchema.optional(),
  inputsDescriptionBien: DescriptionBienInputsSchema.optional(),
  resultsDescriptionBien: DescriptionBienResultsSchema.optional(),
  dvfTransactions: z.array(DvfTransactionSchema).optional(),
  dvfSeries: z.array(DvfSeriesSchema).optional(),
  dvfDistributions: z.array(DvfDistributionSchema).optional(),
  dvfScatters: z.array(DvfScatterSchema).optional(),
});

export type Project = z.infer<typeof ProjectSchema>;
```

## üö¶ Utilisation
- **Importer le type ou le sch√©ma dont vous avez besoin**
- **Valider les donn√©es avec le sch√©ma Zod**
- **Utiliser le type pour le typage statique partout (front et back)**

## üõ°Ô∏è Avantages
- Plus de duplication ni d'ambigu√Øt√©
- Structure claire, √©volutive, et document√©e
- Validation et typage stricts, centralis√©s
- Facile √† compl√©ter ou √† faire √©voluer

---

**Pour toute √©volution‚ÄØ:**
1. Ajouter/modifier le fichier du champ concern√©
2. Mettre √† jour le sch√©ma Project si besoin
3. Utiliser/importer le type partout (front, back, tests)